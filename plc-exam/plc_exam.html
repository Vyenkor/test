<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PLC等级理论考试</title>
  <style>
    body, html { height: 100%; }
    body { font-family: sans-serif; margin: 0; padding: 0; background: #fafafa; min-height: 100vh; display: flex; flex-direction: column; }
    header { background-color: #3f51b5; color: white; padding: 16px; text-align: center; font-size: 1.2rem; flex-shrink: 0; }
    nav { display: flex; background-color: #f5f5f5; border-bottom: 1px solid #ddd; flex-shrink: 0; }
    nav button { flex: 1; padding: 14px 0; border: none; background: none; font-size: 1rem; cursor: pointer; }
    nav button.active { border-bottom: 3px solid #3f51b5; font-weight: bold; background-color: #e0e0e0; }
    
    #content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
    .question-container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .question-header { display: flex; align-items: center; margin-bottom: 10px; }
    .badge { display: inline-block; background-color: #e53935; color: white; border-radius: 12px; padding: 2px 6px; margin-right: 8px; font-size: 0.75rem; }
    .options { margin-bottom: 12px; }
    .option { margin-bottom: 8px; line-height: 1.4; }
    .option input[type="radio"], .option input[type="checkbox"] { margin-right: 8px; }
    .feedback { margin-top: 10px; font-weight: bold; }
    .feedback.correct { color: #388e3c; }
    .feedback.incorrect { color: #e53935; }
    
    .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #f5f5f5; border-top: 1px solid #ddd; padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .hidden { display: none; }
    
    @media (max-width: 600px) {
      .bottom-bar { flex-direction: column; align-items: flex-start; }
      .bottom-bar > div + div { margin-top: 8px; width: 100%; display: flex; justify-content: flex-start; flex-wrap: wrap; gap: 8px; }
      .bottom-bar button { margin-left: 0; flex: 1 1 auto; }
    }
    
    #main-menu { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
    .signature-area { text-align: center; padding: 16px; }
    .signature-area img { max-width: 150px; display: block; margin: 12px auto; border-radius: 8px; }
    
    #top-actions { display: flex; justify-content: center; align-items: center; gap: 10px; padding: 16px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); flex-wrap: wrap; max-width: 600px; margin-bottom: 24px;}
    #top-actions button { padding: 10px 16px; font-size: 1rem; border: 1px solid #3f51b5; background: #3f51b5; color: #fff; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
    #top-actions button:hover { background-color: #303f9f; }
    #exitOnlyBtn { background-color: #757575; border-color: #757575;}
    #exitOnlyBtn:hover { background-color: #616161; }

    .buttons { margin-top: 16px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .buttons button { padding: 8px 16px; font-size: 1rem; border: 1px solid #3f51b5; background: #3f51b5; color: #fff; border-radius: 4px; cursor: pointer; }
    .buttons button:hover { opacity: 0.9; }

    .history-container { max-width: 800px; margin: 0 auto; }
    .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .history-header h2 { margin: 0; }
    .history-entry { background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .history-entry summary { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; font-weight: normal; cursor: pointer; list-style: none; }
    .history-entry summary::-webkit-details-marker { display: none; }
    .history-entry summary .summary-info { display: flex; flex-direction: column; }
    .history-entry summary .summary-info .info-main { font-weight: bold; color: #333; }
    .history-entry summary .summary-info .info-sub { font-size: 0.85rem; color: #757575; margin-top: 4px; }
    .history-details { padding: 12px 16px 16px 16px; border-top: 1px solid #eee; }
    .history-details ul { padding-left: 20px; margin: 0; }
    .history-details li { margin-bottom: 4px; color: #555; }
    .delete-btn { background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
    .delete-btn:hover { opacity: 0.85; }
    #clearHistoryBtn { background-color: #f44336; border-color: #f44336; }
  </style>
</head>
<body>
  <header>
    <h1>PLC等级理论考试</h1>
  </header>
  <nav>
    <button id="tabQuiz" class="active">答题区</button>
    <button id="tabWrong">错题本</button>
  </nav>

  <div id="main-menu">
    <div id="top-actions"></div>
    <div class="signature-area">
      <p>vyen</p>
      <img src="https://youke1.picui.cn/s1/2025/10/04/68e0e8a9ae986.jpg" alt="二维码">
      <p>请为我点赞</p>
    </div>
  </div>

  <div id="content" class="hidden"></div>
  
  <div class="bottom-bar hidden">
    <div id="progress">&nbsp;</div>
  </div>

  <script src="plc_questions_data.js"></script>
  <script>
    (function() {
      const questions = window.plcQuestionsData;
      let mode = '';
      let wrongOrder = [];
      let wrongIndex = 0;
      let wrongCounts = JSON.parse(localStorage.getItem('plc1_wrongCounts') || '{}');
      
      const contentEl = document.getElementById('content');
      const progressEl = document.getElementById('progress');
      const tabQuizBtn = document.getElementById('tabQuiz');
      const tabWrongBtn = document.getElementById('tabWrong');
      const topActionsEl = document.getElementById('top-actions');
      const mainMenuEl = document.getElementById('main-menu');
      const bottomBarEl = document.querySelector('.bottom-bar');
      
      const originalTopActionsHTML = `
        <button id="defaultPracticeBtn">默认刷题</button>
        <button id="random50Btn">随机50题</button>
        <button id="random100Btn">随机100题</button>
        <button id="intervalSequentialBtn">区间顺序</button>
        <button id="intervalRandomBtn">区间随机</button>
        <button id="historyBtn">历史记录</button>
      `;

      let sessionOrder = [];
      let sessionCurrentIndex = 0;
      let sessionSize = 0;
      let sessionWrong = [];
      let sessionName = '';
      let sessionHistory = JSON.parse(localStorage.getItem('plc1_sessionHistory') || '[]');

      function setActiveTab(activeTab) {
          [tabQuizBtn, tabWrongBtn].forEach(tab => tab.classList.remove('active'));
          activeTab.classList.add('active');
      }

      function showMainMenu() {
        mode = 'menu';
        contentEl.classList.add('hidden');
        bottomBarEl.classList.add('hidden');
        mainMenuEl.classList.remove('hidden');
        topActionsEl.innerHTML = originalTopActionsHTML;
        progressEl.innerHTML = '&nbsp;';
        document.querySelector('header h1').textContent = 'PLC等级理论考试';
      }

      document.body.addEventListener('click', (event) => {
        const btn = event.target.closest('button');
        if (!btn || !topActionsEl.contains(btn)) return;

        switch (btn.id) {
          case 'defaultPracticeBtn': startDefaultSequentialPractice(); break;
          case 'random50Btn': startFixedRandomSession(50); break;
          case 'random100Btn': startFixedRandomSession(100); break;
          case 'historyBtn': showHistory(); break;
          case 'shuffleBtn': handleShuffle(); break;
          case 'exitAndSaveBtn': endSession(); break;
          case 'exitOnlyBtn': showMainMenu(); break;
          case 'intervalSequentialBtn': handleIntervalPractice(false); break;
          case 'intervalRandomBtn': handleIntervalPractice(true); break;
          default: break;
        }
      });
      
      tabQuizBtn.addEventListener('click', () => {
        if (!tabQuizBtn.classList.contains('active')) {
            setActiveTab(tabQuizBtn);
            showMainMenu();
        }
      });

      tabWrongBtn.addEventListener('click', () => {
        if (!tabWrongBtn.classList.contains('active')) {
          setActiveTab(tabWrongBtn);
          mode = 'wrong';
          startPracticeSession(null, "错题本模式");
        }
      });
      
      function updateWrongOrder() {
        wrongOrder = Object.keys(wrongCounts).filter(key => wrongCounts[key] > 0).map(num => {
          return questions.findIndex(q => q.number === parseInt(num));
        }).filter(idx => idx !== -1);
      }

      function handleShuffle() {
        if (mode === 'wrong') {
          updateWrongOrder();
          for (let i = wrongOrder.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [wrongOrder[i], wrongOrder[j]] = [wrongOrder[j], wrongOrder[i]];
          }
          wrongIndex = 0;
          showCurrentQuestion();
        }
      }
      
      function handleIntervalPractice(isRandom) {
          const startStr = prompt("请输入起始题号:", "1");
          if (startStr === null) return;
          const endStr = prompt("请输入结束题号:", "50");
          if (endStr === null) return;
          const startNum = parseInt(startStr), endNum = parseInt(endStr);
          const maxQuestionNum = questions.length > 0 ? questions[questions.length - 1].number : 0;
          if (isNaN(startNum) || isNaN(endNum) || startNum < 1 || endNum > maxQuestionNum || startNum > endNum) {
              alert("输入的题号无效或范围不正确。"); return;
          }
          let indices = [];
          for (let i = 0; i < questions.length; i++) {
              if (questions[i].number >= startNum && questions[i].number <= endNum) indices.push(i);
          }
          if(indices.length === 0) { alert("在该范围内没有找到任何题目。"); return; }
          if (isRandom) {
              for (let i = indices.length - 1; i > 0; i--) {
                  const j = Math.floor(Math.random() * (i + 1));
                  [indices[i], indices[j]] = [indices[j], indices[i]];
              }
          }
          const name = isRandom ? `区间随机 (${startNum}-${endNum})` : `区间顺序 (${startNum}-${endNum})`;
          startPracticeSession(indices, name);
      }

      function startFixedRandomSession(size) {
        const indices = questions.map((_, idx) => idx);
        for (let i = indices.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [indices[i], indices[j]] = [indices[j], indices[i]];
        }
        startPracticeSession(indices.slice(0, size), `随机${size}题`);
      }
      
      function startDefaultSequentialPractice() {
          const allIndices = questions.map((_, idx) => idx);
          startPracticeSession(allIndices, "默认刷题 (全)");
      }

      function startPracticeSession(indices, name) {
        sessionName = name;
        mainMenuEl.classList.add('hidden');
        contentEl.classList.remove('hidden');
        bottomBarEl.classList.remove('hidden');
        
        if (mode === 'wrong') {
            updateWrongOrder();
            sessionOrder = wrongOrder;
            topActionsEl.innerHTML = `<span>当前模式: ${sessionName}</span><button id="shuffleBtn">打乱顺序</button><button id="exitOnlyBtn">退出</button>`;
        } else {
            mode = 'session';
            sessionOrder = indices;
            topActionsEl.innerHTML = `<span>当前模式: ${sessionName}</span><button id="exitAndSaveBtn">退出并保存记录</button><button id="exitOnlyBtn">退出</button>`;
        }

        sessionSize = sessionOrder.length;
        sessionCurrentIndex = 0;
        wrongIndex = 0;
        sessionWrong = [];
        showCurrentQuestion();
      }

      function endSession() {
        const wrongCount = sessionWrong.length;
        const attemptedCount = sessionCurrentIndex;
        const entry = { timestamp: Date.now(), mode: sessionName, size: sessionSize, attempted: attemptedCount, wrongCount: wrongCount, wrongQuestions: sessionWrong.slice() };
        sessionHistory.push(entry);
        localStorage.setItem('plc1_sessionHistory', JSON.stringify(sessionHistory));
        let summaryHtml = `<div class="session-summary" style="max-width: 800px; margin: auto;"><h2>练习模式 “${sessionName}” 已结束</h2><p>作答情况：${attemptedCount} / ${sessionSize}</p><p>答错题数：${wrongCount}</p>`;
        if (wrongCount > 0) {
          summaryHtml += '<ul>';
          sessionWrong.forEach(item => { summaryHtml += `<li>题号${item.number}：正确答案 ${item.correctAnswer}（你的答案：${item.userAnswer}）</li>`; });
          summaryHtml += '</ul>';
        } else if (attemptedCount > 0) {
          summaryHtml += '<p>全部答对！</p>';
        }
        summaryHtml += '<button id="sessionReturnBtn">返回主页</button> <button id="viewHistoryBtn">查看历史记录</button></div>';
        contentEl.innerHTML = summaryHtml;
        topActionsEl.innerHTML = '';
        bottomBarEl.classList.add('hidden');
        
        document.getElementById('sessionReturnBtn').addEventListener('click', () => {
            setActiveTab(tabQuizBtn);
            showMainMenu();
        });
        document.getElementById('viewHistoryBtn').addEventListener('click', showHistory);
      }

      function showHistory() {
        sessionHistory = JSON.parse(localStorage.getItem('plc1_sessionHistory') || '[]');
        mainMenuEl.classList.add('hidden');
        contentEl.classList.remove('hidden');
        bottomBarEl.classList.add('hidden');
        topActionsEl.innerHTML = `<span>历史记录</span>`;
        progressEl.textContent = '';
        
        let html = '<div class="history-container">';
        if (!sessionHistory.length) {
          html += '<p>暂无刷题历史记录</p>';
        } else {
          html += `<div class="history-header"><h2>刷题历史记录</h2><button id="clearHistoryBtn" class="delete-btn">清除所有记录</button></div>`;
          sessionHistory.slice().reverse().forEach((entry, idx) => {
            const originalIndex = sessionHistory.length - 1 - idx;
            const dateStr = new Date(entry.timestamp).toLocaleString('zh-CN');
            html += `<div class="history-entry"><details><summary><div class="summary-info"><span class="info-main">${entry.mode}</span><span class="info-sub">${dateStr} | 答${entry.attempted}题 | 错${entry.wrongCount}题</span></div><button class="delete-btn delete-single-btn" data-index="${originalIndex}">删除</button></summary><div class="history-details">`;
            if (entry.wrongCount > 0) {
              html += '<ul>';
              entry.wrongQuestions.forEach(item => { html += `<li>题号${item.number}：正确答案 ${item.correctAnswer}（你的答案：${item.userAnswer}）</li>`; });
              html += '</ul>';
            } else if (entry.attempted > 0) { html += '<p>全部答对！</p>'; } 
            else { html += '<p>未作答题目。</p>'; }
            html += '</div></details></div>';
          });
        }
        html += '<button id="historyBackBtn">返回主页</button></div>';
        contentEl.innerHTML = html;

        contentEl.querySelector('.history-container')?.addEventListener('click', function(event) {
            if (event.target.classList.contains('delete-single-btn')) {
                event.preventDefault(); event.stopPropagation();
                if (confirm('您确定要删除这条记录吗？')) {
                    sessionHistory.splice(parseInt(event.target.dataset.index, 10), 1);
                    localStorage.setItem('plc1_sessionHistory', JSON.stringify(sessionHistory));
                    showHistory();
                }
            }
            if (event.target.id === 'clearHistoryBtn') {
                if (confirm('您确定要清除所有历史记录吗？此操作无法撤销。')) {
                    sessionHistory = [];
                    localStorage.removeItem('plc1_sessionHistory');
                    showHistory();
                }
            }
        });
        document.getElementById('historyBackBtn').addEventListener('click', () => {
            setActiveTab(tabQuizBtn);
            showMainMenu();
        });
      }

      function showCurrentQuestion() {
        let qIndex;
        if (mode === 'wrong') {
          if (wrongOrder.length === 0) {
            contentEl.innerHTML = '<p style="text-align:center;">没有错题～</p>';
            progressEl.textContent = ''; return;
          }
          wrongIndex = Math.max(0, Math.min(wrongIndex, wrongOrder.length - 1));
          qIndex = wrongOrder[wrongIndex];
          sessionCurrentIndex = wrongIndex;
        } else if (mode === 'session') {
          if (sessionCurrentIndex >= sessionOrder.length) { endSession(); return; }
          qIndex = sessionOrder[sessionCurrentIndex];
        } else { return; }

        const q = questions[qIndex];
        let total = sessionOrder.length;
        let currentPos = sessionCurrentIndex + 1;
        
        const displayType = (q.options.length === 0) ? '判断' : q.type;
        progressEl.textContent = `【${displayType}】【${currentPos}/${total}】`;
        wrongCounts = JSON.parse(localStorage.getItem('plc1_wrongCounts') || '{}');
        const wrongCount = wrongCounts[q.number] || 0;
        let html = `<div class="question-container"><div class="question-header">${wrongCount > 0 ? `<span class="badge">已错 ${wrongCount} 次</span>` : ''}<span>${q.question}</span></div><div class="options">`;
        if (q.options.length === 0) {
          html += `<div class="option"><label><input type="radio" name="answer" value="T"> 正确</label></div><div class="option"><label><input type="radio" name="answer" value="F"> 错误</label></div>`;
        } else {
          const inputType = (q.type === '多选') ? 'checkbox' : 'radio';
          q.options.forEach(opt => {
            let text = (opt.text || '').trim() || '（空）';
            html += `<div class="option"><label><input type="${inputType}" name="answer" value="${opt.label}"> ${opt.label}、${text}</label></div>`;
          });
        }
        html += `</div><div class="buttons"><button id="submitBtn">提交答案</button><button id="retryBtn" class="hidden">再试一次</button><button id="prevBtn" class="hidden">上一题</button><button id="nextBtn" class="hidden">下一题</button><button id="removeWrongBtn" class="hidden">从错题本中移除</button></div><div id="feedback" class="feedback"></div></div>`;
        contentEl.innerHTML = html;
        
        const submitBtn = document.getElementById('submitBtn'), retryBtn = document.getElementById('retryBtn'), nextBtn = document.getElementById('nextBtn'), prevBtn = document.getElementById('prevBtn'), removeWrongBtn = document.getElementById('removeWrongBtn');
        
        if (sessionCurrentIndex > 0) {
            prevBtn.classList.remove('hidden');
        }

        submitBtn.addEventListener('click', () => handleSubmit(q, submitBtn, retryBtn, nextBtn, prevBtn, removeWrongBtn));
        retryBtn.addEventListener('click', showCurrentQuestion);
        
        prevBtn.addEventListener('click', () => {
            if (mode === 'wrong') wrongIndex--;
            sessionCurrentIndex--;
            showCurrentQuestion();
        });

        nextBtn.addEventListener('click', () => {
          if (mode === 'wrong') wrongIndex++;
          sessionCurrentIndex++;
          showCurrentQuestion();
        });
        removeWrongBtn.addEventListener('click', () => {
          delete wrongCounts[q.number];
          localStorage.setItem('plc1_wrongCounts', JSON.stringify(wrongCounts));
          removeWrongBtn.textContent = '已移除';
          removeWrongBtn.disabled = true;
        });
      }

      function handleSubmit(q, submitBtn, retryBtn, nextBtn, prevBtn, removeWrongBtn) {
        const selected = Array.from(contentEl.querySelectorAll('input[name="answer"]:checked'));
        if (selected.length === 0) { alert('请选择答案后再提交'); return; }
        const userAnswers = selected.map(el => el.value).sort();
        let correct = false, correctDisplay;
        if (q.options.length === 0) {
          const expected = !q.answer.some(ans => ans.includes('错') || ans.includes('误')) ? 'T' : 'F';
          correct = (userAnswers[0] === expected);
          correctDisplay = expected === 'T' ? '正确' : '错误';
        } else {
          const correctAnswers = q.answer.slice().sort();
          correct = (userAnswers.length === correctAnswers.length && userAnswers.every((v, i) => v === correctAnswers[i]));
          correctDisplay = q.answer.join('');
        }
        submitBtn.disabled = true;
        const feedbackEl = document.getElementById('feedback');
        if (correct) {
          feedbackEl.textContent = '回答正确！';
          feedbackEl.className = 'feedback correct';
          nextBtn.classList.remove('hidden');
          retryBtn.classList.add('hidden');
          if (mode === 'wrong') removeWrongBtn.classList.remove('hidden');
        } else {
          wrongCounts[q.number] = (wrongCounts[q.number] || 0) + 1;
          localStorage.setItem('plc1_wrongCounts', JSON.stringify(wrongCounts));
          feedbackEl.textContent = '回答错误！正确答案：' + correctDisplay;
          feedbackEl.className = 'feedback incorrect';
          retryBtn.classList.remove('hidden');
          nextBtn.classList.remove('hidden');
          if (mode !== 'wrong' && !sessionWrong.some(item => item.number === q.number)) {
            sessionWrong.push({ number: q.number, correctAnswer: correctDisplay, userAnswer: userAnswers.join('') });
          }
        }
      }
      
      showMainMenu();
    })();
  </script>
</body>
</html>