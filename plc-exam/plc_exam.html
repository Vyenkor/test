<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PLC等级理论考试</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #fafafa; min-height: 100vh; display: flex; flex-direction: column; }
    header { background-color: #3f51b5; color: white; padding: 16px; text-align: center; font-size: 1.2rem; flex-shrink: 0; }
    nav { display: flex; background-color: #f5f5f5; border-bottom: 1px solid #ddd; flex-shrink: 0; }
    nav button { flex: 1; padding: 14px 0; border: none; background: none; font-size: 1rem; cursor: pointer; }
    nav button.active { border-bottom: 3px solid #3f51b5; font-weight: bold; background-color: #e0e0e0; }
    #content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      /* 给内容区增加底部填充，以防固定底栏遮挡内容 */
      padding-bottom: 100px;
    }
    .question-container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .question-header { display: flex; align-items: center; margin-bottom: 10px; }
    .badge { display: inline-block; background-color: #e53935; color: white; border-radius: 12px; padding: 2px 6px; margin-right: 8px; font-size: 0.75rem; }
    .options { margin-bottom: 12px; }
    .option { margin-bottom: 8px; line-height: 1.4; }
    .option input[type="radio"], .option input[type="checkbox"] { margin-right: 8px; }
    .feedback { margin-top: 10px; font-weight: bold; }
    .feedback.correct { color: #388e3c; }
    .feedback.incorrect { color: #e53935; }
    .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #f5f5f5; border-top: 1px solid #ddd; padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .bottom-bar button { margin-left: 8px; padding: 6px 12px; border: 1px solid #3f51b5; border-radius: 4px; background: #3f51b5; color: white; cursor: pointer; font-size: 0.9rem; }
    .bottom-bar button:hover { opacity: 0.9; }
    .hidden { display: none; }
    /* 移动端布局调整：当屏幕较窄时，底栏内容垂直堆叠，按钮换行 */
    @media (max-width: 600px) {
      .bottom-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .bottom-bar > div + div {
        margin-top: 8px;
        width: 100%;
        display: flex;
        justify-content: flex-start;
        flex-wrap: wrap;
        gap: 8px;
      }
      .bottom-bar button {
        margin-left: 0;
        flex: 1 1 auto;
      }
    }
    /* 署名区域样式 */
    #signature-area {
      text-align: center;
      padding: 16px;
    }
    #signature-area img {
      max-width: 120px;
      display: block;
      margin: 8px auto;
    }
    /* 顶部操作按钮区域样式 */
    #top-actions {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      flex-wrap: wrap;
    }
    #top-actions button {
      padding: 6px 12px;
      font-size: 0.9rem;
      border: 1px solid #3f51b5;
      background: #3f51b5;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    #top-actions button:hover {
      opacity: 0.9;
    }
    /* 调整答题区内按钮大小 */
    .buttons button {
      padding: 8px 16px;
      font-size: 1rem;
      margin-right: 8px;
      border: 1px solid #3f51b5;
      background: #3f51b5;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    .buttons button:last-child {
      margin-right: 0;
    }
    .buttons button:hover {
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <header>
    <h1>PLC等级理论考试</h1>
  </header>
  <nav>
    <button id="tabQuiz" class="active">答题区</button>
    <button id="tabWrong">错题本</button>
  </nav>
  <div id="top-actions">
    <button id="shuffleBtn">随机打乱</button>
    <button id="random50Btn">随机50题</button>
    <button id="random100Btn">随机100题</button>
    <button id="historyBtn">历史记录</button>
  </div>
  <div id="signature-area">
    <p>vyen</p>
    <img src="https://youke1.picui.cn/s1/2025/10/04/68e0e8a9ae986.jpg" alt="二维码">
    <p>请为我点赞</p>
  </div>
  <div id="content"></div>
  <div class="bottom-bar">
    <div id="progress">&nbsp;</div>
  </div>
  <script src="plc_questions_data.js"></script>
  <script>
    (function() {
      // 使用 PLC 题库数据
      const questions = window.plcQuestionsData;
      let mode = 'quiz';
      let order = questions.map((_, idx) => idx);
      let currentIndex = 0;
      let wrongOrder = [];
      let wrongIndex = 0;
      // 从 localStorage 读取错题统计（为 PLC 考试单独的键）
      let wrongCounts = JSON.parse(localStorage.getItem('plc1_wrongCounts') || '{}');
      function updateWrongOrder() {
        wrongOrder = Object.keys(wrongCounts).filter(key => wrongCounts[key] > 0).map(num => {
          return questions.findIndex(q => q.number === parseInt(num));
        }).filter(idx => idx !== -1);
      }
      updateWrongOrder();
      const contentEl = document.getElementById('content');
      const progressEl = document.getElementById('progress');
      const tabQuizBtn = document.getElementById('tabQuiz');
      const tabWrongBtn = document.getElementById('tabWrong');
      const topActionsEl = document.getElementById('top-actions');
      const originalTopActionsHTML = topActionsEl.innerHTML;

      // 会话相关变量
      let sessionOrder = [];
      let sessionCurrentIndex = 0;
      let sessionSize = 0;
      let sessionWrong = [];
      // 历史记录，存储每次随机刷题结果（PLC 考试专用键）
      let sessionHistory = JSON.parse(localStorage.getItem('plc1_sessionHistory') || '[]');

      /**
       * 恢复顶部操作按钮
       */
      function restoreTopActions() {
        topActionsEl.innerHTML = originalTopActionsHTML;
      }
      
      // 使用事件委托处理顶部按钮点击
      topActionsEl.addEventListener('click', (event) => {
        const btn = event.target.closest('button');
        if (!btn) return;
        switch (btn.id) {
          case 'random50Btn':
            startSession(50);
            break;
          case 'random100Btn':
            startSession(100);
            break;
          case 'historyBtn':
            showHistory();
            break;
          case 'shuffleBtn':
            handleShuffle();
            break;
          case 'exitSessionBtn':
            endSession();
            break;
          default:
            break;
        }
      });
      
      // 切换标签
      tabQuizBtn.addEventListener('click', () => {
        if (mode !== 'quiz') {
          mode = 'quiz';
          tabQuizBtn.classList.add('active');
          tabWrongBtn.classList.remove('active');
          restoreTopActions();
          showCurrentQuestion();
        }
      });
      tabWrongBtn.addEventListener('click', () => {
        if (mode !== 'wrong') {
          mode = 'wrong';
          tabWrongBtn.classList.add('active');
          tabQuizBtn.classList.remove('active');
          restoreTopActions();
          showCurrentQuestion();
        }
      });

      // 随机打乱功能
      function handleShuffle() {
        if (mode === 'quiz') {
          for (let i = order.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [order[i], order[j]] = [order[j], order[i]];
          }
          currentIndex = 0;
          showCurrentQuestion();
        } else if (mode === 'wrong') {
          updateWrongOrder();
          for (let i = wrongOrder.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [wrongOrder[i], wrongOrder[j]] = [wrongOrder[j], wrongOrder[i]];
          }
          wrongIndex = 0;
          showCurrentQuestion();
        }
      }

      /**
       * 开始随机刷题
       * @param {number} size 题目数量
       */
      function startSession(size) {
        mode = 'session';
        sessionSize = size;
        // 更改顶部操作区UI
        topActionsEl.innerHTML = `
          <span>当前模式: 随机${size}题</span> 
          <button id="exitSessionBtn">退出并保存到历史记录</button>
        `;
        // 生成索引并随机
        const indices = questions.map((_, idx) => idx);
        for (let i = indices.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [indices[i], indices[j]] = [indices[j], indices[i]];
        }
        sessionOrder = indices.slice(0, size);
        sessionCurrentIndex = 0;
        sessionWrong = [];
        showCurrentQuestion();
      }
      /**
       * 完成随机刷题后的统计
       */
      function endSession() {
        const wrongCount = sessionWrong.length;
        const attemptedCount = sessionCurrentIndex;
        // 保存历史记录
        const entry = {
          timestamp: Date.now(),
          size: sessionSize,
          attempted: attemptedCount,
          wrongCount: wrongCount,
          wrongQuestions: sessionWrong.slice()
        };
        sessionHistory.push(entry);
        localStorage.setItem('plc1_sessionHistory', JSON.stringify(sessionHistory));
        // 显示总结
        let summaryHtml = '<div class="session-summary">';
        summaryHtml += `<h2>本次随机${sessionSize}题已完成</h2>`;
        summaryHtml += `<p>作答情况：${attemptedCount} / ${sessionSize}</p>`;
        summaryHtml += `<p>答错题数：${wrongCount}</p>`;
        if (wrongCount > 0) {
          summaryHtml += '<ul>';
          sessionWrong.forEach(item => {
            summaryHtml += `<li>题号${item.number}：正确答案 ${item.correctAnswer}`;
            if (item.userAnswer && item.userAnswer !== item.correctAnswer) {
              summaryHtml += `（你的答案：${item.userAnswer}）`;
            }
            summaryHtml += '</li>';
          });
          summaryHtml += '</ul>';
        } else if (attemptedCount > 0) {
          summaryHtml += '<p>全部答对！</p>';
        }
        summaryHtml += '<button id="sessionReturnBtn">返回答题区</button> ';
        summaryHtml += '<button id="viewHistoryBtn">查看历史记录</button>';
        summaryHtml += '</div>';
        contentEl.innerHTML = summaryHtml;
        progressEl.textContent = '';
        document.getElementById('sessionReturnBtn').addEventListener('click', () => {
          mode = 'quiz';
          restoreTopActions();
          showCurrentQuestion();
        });
        document.getElementById('viewHistoryBtn').addEventListener('click', () => {
          showHistory();
        });
      }
      /**
       * 显示历史记录
       */
      function showHistory() {
        mode = 'history';
        sessionHistory = JSON.parse(localStorage.getItem('plc1_sessionHistory') || '[]');
        topActionsEl.innerHTML = `<span>历史记录</span>`;

        if (!sessionHistory.length) {
          contentEl.innerHTML = '<p>暂无刷题历史记录</p><button id="historyBackBtn">返回答题区</button>';
          progressEl.textContent = '';
          document.getElementById('historyBackBtn').addEventListener('click', () => {
            mode = 'quiz';
            restoreTopActions();
            showCurrentQuestion();
          });
          return;
        }
        let html = '<div class="history-list">';
        html += '<h2>刷题历史记录</h2>';
        sessionHistory.slice().reverse().forEach((entry, idx) => {
          const date = new Date(entry.timestamp);
          const dateStr = date.toLocaleString('zh-CN');
          const attemptedText = entry.attempted !== undefined ? `，答${entry.attempted}题` : '';
          html += `<details><summary>第${sessionHistory.length - idx}次 - ${dateStr} - ${entry.size}题模式${attemptedText}，错${entry.wrongCount}题</summary>`;
          if (entry.wrongCount > 0) {
            html += '<ul>';
            entry.wrongQuestions.forEach(item => {
              html += `<li>题号${item.number}：正确答案 ${item.correctAnswer}`;
              if (item.userAnswer && item.userAnswer !== item.correctAnswer) {
                html += `（你的答案：${item.userAnswer}）`;
              }
              html += '</li>';
            });
            html += '</ul>';
          } else if (entry.attempted > 0) {
            html += '<p>全部答对！</p>';
          } else {
            html += '<p>未作答题目。</p>';
          }
          html += '</details>';
        });
        html += '<button id="historyBackBtn">返回答题区</button>';
        html += '</div>';
        contentEl.innerHTML = html;
        progressEl.textContent = '';
        document.getElementById('historyBackBtn').addEventListener('click', () => {
          mode = 'quiz';
          restoreTopActions();
          showCurrentQuestion();
        });
      }
      /**
       * 显示当前题目
       */
      function showCurrentQuestion() {
        let qIndex;
        if (mode === 'quiz') {
          if (order.length === 0) return;
          if (currentIndex < 0) currentIndex = 0;
          if (currentIndex >= order.length) currentIndex = 0;
          qIndex = order[currentIndex];
        } else if (mode === 'wrong') {
          updateWrongOrder();
          if (wrongOrder.length === 0) {
            contentEl.innerHTML = '<p>没有错题～</p>';
            progressEl.textContent = '';
            return;
          }
          if (wrongIndex < 0) wrongIndex = 0;
          if (wrongIndex >= wrongOrder.length) wrongIndex = 0;
          qIndex = wrongOrder[wrongIndex];
        } else if (mode === 'session') {
          if (sessionCurrentIndex >= sessionOrder.length) {
            endSession();
            return;
          }
          qIndex = sessionOrder[sessionCurrentIndex];
        } else {
          return;
        }
        const q = questions[qIndex];
        let total, currentPos;
        if (mode === 'quiz') {
          total = order.length;
          currentPos = currentIndex + 1;
        } else if (mode === 'wrong') {
          total = wrongOrder.length;
          currentPos = wrongIndex + 1;
        } else if (mode === 'session') {
          total = sessionOrder.length;
          currentPos = sessionCurrentIndex + 1;
        }
        // 显示题型
        const displayType = (q.options.length === 0) ? '判断' : q.type;
        progressEl.textContent = `【${displayType}】【${currentPos}/${total}】`;
        // BUG FIX: Ensure wrongCounts is re-read from storage to be fresh
        wrongCounts = JSON.parse(localStorage.getItem('plc1_wrongCounts') || '{}');
        const wrongCount = wrongCounts[q.number] || 0;
        let html = '<div class="question-container">';
        html += '<div class="question-header">';
        if (wrongCount > 0) {
          html += `<span class="badge">已错 ${wrongCount} 次</span>`;
        }
        html += `<span>${q.question}</span>`;
        html += '</div>';
        html += '<div class="options">';
        let inputType;
        let optionsList;
        if (q.options.length === 0) {
          inputType = 'radio';
          optionsList = [
            { value: 'T', label: '正确' },
            { value: 'F', label: '错误' }
          ];
        } else {
          inputType = (q.type === '多选') ? 'checkbox' : 'radio';
          optionsList = q.options.map(opt => {
            let text = (opt.text || '').trim();
            if (!text) {
              text = '（空）';
            }
            return { value: opt.label, label: `${opt.label}、${text}` };
          });
        }
        optionsList.forEach(opt => {
          html += `<div class="option"><label><input type="${inputType}" name="answer" value="${opt.value}"> ${opt.label}</label></div>`;
        });
        html += '</div>';
        html += '<div class="buttons">';
        html += '<button id="submitBtn">提交答案</button>';
        html += '<button id="retryBtn" class="hidden">再试一次</button>';
        html += '<button id="nextBtn" class="hidden">下一题</button>';
        // ENHANCEMENT: Add hidden button for removing from wrong set
        html += '<button id="removeWrongBtn" class="hidden">从错题本中移除</button>';
        html += '</div>';
        html += '<div id="feedback" class="feedback"></div>';
        html += '</div>';
        contentEl.innerHTML = html;
        const submitBtn = document.getElementById('submitBtn');
        const retryBtn = document.getElementById('retryBtn');
        const nextBtn = document.getElementById('nextBtn');
        const removeWrongBtn = document.getElementById('removeWrongBtn');
        const feedbackEl = document.getElementById('feedback');
        
        submitBtn.addEventListener('click', () => {
          handleSubmit(q, qIndex, inputType, submitBtn, retryBtn, nextBtn, removeWrongBtn, feedbackEl);
        });
        
        retryBtn.addEventListener('click', () => { showCurrentQuestion(); });
        
        nextBtn.addEventListener('click', () => {
          if (mode === 'quiz') {
            currentIndex++;
            if (currentIndex >= order.length) currentIndex = 0;
          } else if (mode === 'wrong') {
            wrongIndex++;
            if (wrongIndex >= wrongOrder.length) wrongIndex = 0;
          } else if (mode === 'session') {
            sessionCurrentIndex++;
          }
          showCurrentQuestion();
        });

        removeWrongBtn.addEventListener('click', () => {
          // Remove from wrong counts and save
          delete wrongCounts[q.number];
          localStorage.setItem('plc1_wrongCounts', JSON.stringify(wrongCounts));
          removeWrongBtn.textContent = '已移除';
          removeWrongBtn.disabled = true;
        });
      }
      /**
       * 提交答案处理
       */
      function handleSubmit(q, qIndex, inputType, submitBtn, retryBtn, nextBtn, removeWrongBtn, feedbackEl) {
        const selected = Array.from(contentEl.querySelectorAll('input[name="answer"]:checked'));
        if (selected.length === 0) {
          alert('请选择答案后再提交');
          return;
        }
        const userAnswers = selected.map(el => el.value).sort();
        let correct = false;
        let correctDisplay;
        if (q.options.length === 0) {
          // 判断题
          const isTrueAnswer = !q.answer.some(ans => ans.trim().includes('错') || ans.trim().includes('误'));
          const expected = isTrueAnswer ? 'T' : 'F';
          correct = (userAnswers.length === 1 && userAnswers[0] === expected);
          correctDisplay = isTrueAnswer ? '正确' : '错误';
        } else {
          const correctAnswers = q.answer.slice().sort();
          correct = (userAnswers.length === correctAnswers.length && userAnswers.every((v, i) => v === correctAnswers[i]));
          correctDisplay = q.answer.join('');
        }
        
        submitBtn.disabled = true;

        if (correct) {
          feedbackEl.textContent = '回答正确！';
          feedbackEl.className = 'feedback correct';
          nextBtn.classList.remove('hidden');
          retryBtn.classList.add('hidden');
          // ENHANCEMENT: If correct in wrong mode, show remove button
          if (mode === 'wrong') {
            removeWrongBtn.classList.remove('hidden');
          }
        } else {
          // BUG FIX: This logic now correctly applies to all modes, including 'session'.
          wrongCounts[q.number] = (wrongCounts[q.number] || 0) + 1;
          localStorage.setItem('plc1_wrongCounts', JSON.stringify(wrongCounts));
          feedbackEl.textContent = '回答错误！正确答案：' + correctDisplay;
          feedbackEl.className = 'feedback incorrect';
          retryBtn.classList.remove('hidden');
          nextBtn.classList.remove('hidden');

          // Record wrong answer in session mode for summary
          if (mode === 'session') {
            const alreadyLogged = sessionWrong.some(item => item.number === q.number);
            if (!alreadyLogged) {
              sessionWrong.push({
                number: q.number,
                correctAnswer: correctDisplay,
                userAnswer: userAnswers.join('')
              });
            }
          }
        }
      }
      // 初始化显示题目
      showCurrentQuestion();
    })();
  </script>
</body>
</html>