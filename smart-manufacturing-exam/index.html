<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!--
    This page mirrors the PLC exam page functionality but is tailored for the
    智能制造系统集成赛项理论试题 exam. It loads its question set from
    questions_data.js and persists state using unique localStorage keys to
    avoid collisions with other exam pages. The home page displays a list of
    recent updates to let users know about new features such as resuming
    unfinished sessions, the removal of the answer area on the home page,
    custom interval practice (sequential or random), and a previous-question
    button. These updates are only visible on the home page and are hidden
    while practicing or viewing history.
  -->
  <title>智能制造系统集成赛项理论试题</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #fafafa; min-height: 100vh; display: flex; flex-direction: column; }
    header { background-color: #3f51b5; color: white; padding: 16px; text-align: center; font-size: 1.2rem; flex-shrink: 0; }
    nav { display: flex; background-color: #f5f5f5; border-bottom: 1px solid #ddd; flex-shrink: 0; }
    nav button { flex: 1; padding: 14px 0; border: none; background: none; font-size: 1rem; cursor: pointer; }
    nav button.active { border-bottom: 3px solid #3f51b5; font-weight: bold; background-color: #e0e0e0; }
    #content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: 100px;
    }
    .question-container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .question-header { display: flex; align-items: center; margin-bottom: 10px; }
    .badge { display: inline-block; background-color: #e53935; color: white; border-radius: 12px; padding: 2px 6px; margin-right: 8px; font-size: 0.75rem; }
    .options { margin-bottom: 12px; }
    .option { margin-bottom: 8px; line-height: 1.4; }
    .option input[type="radio"], .option input[type="checkbox"] { margin-right: 8px; }
    .feedback { margin-top: 10px; font-weight: bold; }
    .feedback.correct { color: #388e3c; }
    .feedback.incorrect { color: #e53935; }
    .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #f5f5f5; border-top: 1px solid #ddd; padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .bottom-bar button { margin-left: 8px; padding: 6px 12px; border: 1px solid #3f51b5; border-radius: 4px; background: #3f51b5; color: white; cursor: pointer; font-size: 0.9rem; }
    .bottom-bar button:hover { opacity: 0.9; }
    .hidden { display: none; }

    /* Mobile layout adjustments for the bottom bar */
    @media (max-width: 600px) {
      .bottom-bar { flex-direction: column; align-items: flex-start; }
      .bottom-bar > div + div { margin-top: 8px; width: 100%; display: flex; justify-content: flex-start; flex-wrap: wrap; gap: 8px; }
      .bottom-bar button { margin-left: 0; flex: 1 1 auto; }
    }

    /* Signature area */
    #signature-area { text-align: center; padding: 16px; }
    #signature-area img { max-width: 120px; display: block; margin: 8px auto; }

    /* Top actions */
    #top-actions { display: flex; justify-content: center; gap: 8px; padding: 8px 16px; background: #f5f5f5; border-bottom: 1px solid #ddd; flex-wrap: wrap; }
    #top-actions button { padding: 6px 12px; font-size: 0.9rem; border: 1px solid #3f51b5; background: #3f51b5; color: #fff; border-radius: 4px; cursor: pointer; }
    #top-actions button:hover { opacity: 0.9; }

    /* Question action buttons */
    .buttons button { padding: 8px 16px; font-size: 1rem; margin-right: 8px; border: 1px solid #3f51b5; background: #3f51b5; color: #fff; border-radius: 4px; cursor: pointer; }
    .buttons button:last-child { margin-right: 0; }
    .buttons button:hover { opacity: 0.9; }

    /* Update area styles (recent updates list) */
    #update-area {
      background: #fffbe6;
      border: 1px solid #ffe58f;
      padding: 12px 16px;
      margin: 12px auto;
      max-width: 800px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    #update-area.hidden { display: none; }
    #update-area h3 { margin-top: 0; }
    #update-area ul { padding-left: 20px; margin: 8px 0 0 0; }
    #update-area ul li { line-height: 1.6; }

    /* History page styles */
    .history-container { max-width: 800px; margin: 0 auto; }
    .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .history-header h2 { margin: 0; }
    .history-entry { background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .history-entry summary { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; font-weight: normal; cursor: pointer; list-style: none; }
    .history-entry summary::-webkit-details-marker { display: none; }
    .history-entry summary .summary-info { display: flex; flex-direction: column; }
    .history-entry summary .summary-info .info-main { font-weight: bold; color: #333; }
    .history-entry summary .summary-info .info-sub { font-size: 0.85rem; color: #757575; margin-top: 4px; }
    .history-details { padding: 12px 16px 16px 16px; border-top: 1px solid #eee; }
    .history-details ul { padding-left: 20px; margin: 0; }
    .history-details li { margin-bottom: 4px; color: #555; }
    .delete-btn { background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
    .delete-btn:hover { opacity: 0.85; }
    #clearHistoryBtn { background-color: #f44336; border-color: #f44336; }
  </style>
</head>
<body>
  <header>
    <h1>智能制造系统集成赛项理论试题</h1>
  </header>
  <nav>
    <button id="tabQuiz" class="active">答题区</button>
    <button id="tabWrong">错题本</button>
  </nav>
  <div id="top-actions"></div>
  <!-- Recent updates list (visible only on the home page) -->
  <div id="update-area">
    <h3>最近更新动态</h3>
    <ul>
      <li>历史记录可以继续之前未完成的答题任务</li>
      <li>主页移除了答题区域</li>
      <li>增加自定义区间顺序乱序答题</li>
      <li>增加上一题功能</li>
    </ul>
  </div>
  <div id="signature-area">
    <p>vyen</p>
    <img src="https://youke1.picui.cn/s1/2025/10/04/68e0e8a9ae986.jpg" alt="二维码">
    <p>请为我点赞</p>
  </div>
  <!-- The content area (initially hidden) -->
  <div id="content" class="hidden"></div>
  <div class="bottom-bar">
    <div id="progress">&nbsp;</div>
  </div>
  <!-- Load questions for smart manufacturing exam -->
  <script src="questions_data.js"></script>
  <script>
    (function() {
      // Use the question data from the external script. Ensure this file defines window.questionsData.
      const questions = window.questionsData;
      // Mode can be quiz, wrong, session, or history.
      let mode = 'quiz';
      // Quiz mode variables
      let order = questions.map((_, idx) => idx);
      let currentIndex = 0;
      // Wrong mode variables
      let wrongOrder = [];
      let wrongIndex = 0;
      // Store wrong answer counts in localStorage with unique key for this exam
      let wrongCounts = JSON.parse(localStorage.getItem('smart_wrongCounts') || '{}');
      function updateWrongOrder() {
        wrongOrder = Object.keys(wrongCounts).filter(key => wrongCounts[key] > 0).map(num => {
          return questions.findIndex(q => q.number === parseInt(num));
        }).filter(idx => idx !== -1);
      }
      updateWrongOrder();
      // DOM elements
      const contentEl = document.getElementById('content');
      const progressEl = document.getElementById('progress');
      const tabQuizBtn = document.getElementById('tabQuiz');
      const tabWrongBtn = document.getElementById('tabWrong');
      const topActionsEl = document.getElementById('top-actions');
      const updateArea = document.getElementById('update-area');
      // Top actions template (dynamic)
      const originalTopActionsHTML = `
        <button id="shuffleBtn">随机打乱</button>
        <button id="random50Btn">随机50题</button>
        <button id="random100Btn">随机100题</button>
        <button id="fullBtn">完整刷题</button>
        <button id="intervalSequentialBtn">区间顺序</button>
        <button id="intervalRandomBtn">区间随机</button>
        <button id="historyBtn">历史记录</button>
      `;
      // Session variables
      let sessionOrder = [];
      let sessionCurrentIndex = 0;
      let sessionSize = 0;
      let sessionWrong = [];
      let sessionName = '';
      // Load history from localStorage (unique key)
      let sessionHistory = JSON.parse(localStorage.getItem('smart_sessionHistory') || '[]');
      // Index of the history entry being resumed (null if none)
      let currentHistoryResumeIndex = null;
      // Saved session state when switching tabs
      let savedSessionState = null;
      function restoreTopActions() {
        topActionsEl.innerHTML = originalTopActionsHTML;
        // Show update list on home page
        if (updateArea) {
          updateArea.classList.remove('hidden');
        }
      }
      // Top actions click handler
      topActionsEl.addEventListener('click', (event) => {
        const btn = event.target.closest('button');
        if (!btn) return;
        switch (btn.id) {
          case 'random50Btn': startFixedRandomSession(50); break;
          case 'random100Btn': startFixedRandomSession(100); break;
          case 'fullBtn': startFullPractice(); break;
          case 'historyBtn': showHistory(); break;
          case 'shuffleBtn': handleShuffle(); break;
          case 'exitSessionBtn': endSession(); break;
          case 'intervalSequentialBtn': handleIntervalPractice(false); break;
          case 'intervalRandomBtn': handleIntervalPractice(true); break;
          default: break;
        }
      });
      // Quiz tab click
      tabQuizBtn.addEventListener('click', () => {
        // Restore session if previously saved
        if (savedSessionState) {
          const state = savedSessionState;
          mode = 'session';
          sessionOrder = state.sessionOrder.slice();
          sessionSize = state.sessionSize;
          sessionName = state.sessionName;
          sessionCurrentIndex = state.sessionCurrentIndex;
          sessionWrong = state.sessionWrong.slice();
          currentHistoryResumeIndex = state.historyIndex;
          savedSessionState = null;
          topActionsEl.innerHTML = `<span>当前模式: ${sessionName}</span><button id="exitSessionBtn">退出并保存到历史记录</button>`;
          tabQuizBtn.classList.add('active');
          tabWrongBtn.classList.remove('active');
          contentEl.classList.remove('hidden');
          if (updateArea) {
            updateArea.classList.add('hidden');
          }
          showCurrentQuestion();
        } else {
          // Switch to quiz home page
          if (mode !== 'quiz') {
            mode = 'quiz';
            tabQuizBtn.classList.add('active');
            tabWrongBtn.classList.remove('active');
            restoreTopActions();
            // Hide content until a new session begins
            contentEl.classList.add('hidden');
            contentEl.innerHTML = '';
            progressEl.textContent = '';
          }
        }
      });
      // Wrong tab click
      tabWrongBtn.addEventListener('click', () => {
        if (mode === 'session' || savedSessionState) {
          // Save current session state if not saved yet
          if (!savedSessionState) {
            savedSessionState = {
              sessionOrder: sessionOrder.slice(),
              sessionSize: sessionSize,
              sessionName: sessionName,
              sessionCurrentIndex: sessionCurrentIndex,
              sessionWrong: sessionWrong.slice(),
              historyIndex: currentHistoryResumeIndex
            };
          }
          mode = 'wrong';
          tabWrongBtn.classList.add('active');
          tabQuizBtn.classList.remove('active');
          topActionsEl.innerHTML = `<span>当前模式: ${sessionName}</span><button id="exitSessionBtn">退出并保存到历史记录</button>`;
          if (updateArea) updateArea.classList.add('hidden');
          updateWrongOrder();
          wrongIndex = 0;
          contentEl.classList.remove('hidden');
          showCurrentQuestion();
        } else {
          if (mode !== 'wrong') {
            mode = 'wrong';
            tabWrongBtn.classList.add('active');
            tabQuizBtn.classList.remove('active');
            restoreTopActions();
            if (updateArea) updateArea.classList.add('hidden');
            updateWrongOrder();
            wrongIndex = 0;
            if (wrongOrder.length === 0) {
              contentEl.innerHTML = '<p>没有错题～</p>';
              progressEl.textContent = '';
              contentEl.classList.remove('hidden');
            } else {
              contentEl.classList.remove('hidden');
              showCurrentQuestion();
            }
          }
        }
      });
      // Shuffle random sessions
      function handleShuffle() {
        if (mode === 'session') return;
        if (mode === 'quiz') {
          const indices = questions.map((_, idx) => idx);
          for (let i = indices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [indices[i], indices[j]] = [indices[j], indices[i]];
          }
          startPracticeSession(indices, '随机打乱');
        } else if (mode === 'wrong') {
          updateWrongOrder();
          for (let i = wrongOrder.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [wrongOrder[i], wrongOrder[j]] = [wrongOrder[j], wrongOrder[i]];
          }
          if (wrongOrder.length > 0) {
            startPracticeSession(wrongOrder.slice(), '错题乱序');
          } else {
            contentEl.innerHTML = '<p>没有错题～</p>';
            progressEl.textContent = '';
            contentEl.classList.remove('hidden');
          }
        }
      }
      // Custom interval practice
      function handleIntervalPractice(isRandom) {
        const startStr = prompt('请输入起始题号:', '1');
        if (startStr === null) return;
        const endStr = prompt('请输入结束题号:', '50');
        if (endStr === null) return;
        const startNum = parseInt(startStr);
        const endNum = parseInt(endStr);
        const maxQuestionNum = questions[questions.length - 1].number;
        if (isNaN(startNum) || isNaN(endNum) || startNum < 1 || endNum > maxQuestionNum || startNum > endNum) {
          alert('输入的题号无效或范围不正确。请确保起始题号小于等于结束题号，且在 1 到 ' + maxQuestionNum + ' 之间。');
          return;
        }
        let indices = [];
        for (let i = 0; i < questions.length; i++) {
          if (questions[i].number >= startNum && questions[i].number <= endNum) {
            indices.push(i);
          }
        }
        if (indices.length === 0) {
          alert('在该范围内没有找到任何题目。');
          return;
        }
        if (isRandom) {
          for (let i = indices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [indices[i], indices[j]] = [indices[j], indices[i]];
          }
        }
        const name = isRandom ? `区间随机 (${startNum}-${endNum})` : `区间顺序 (${startNum}-${endNum})`;
        startPracticeSession(indices, name);
      }
      // Random fixed-size sessions
      function startFixedRandomSession(size) {
        const indices = questions.map((_, idx) => idx);
        for (let i = indices.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [indices[i], indices[j]] = [indices[j], indices[i]];
        }
        const sessionIndices = indices.slice(0, size);
        startPracticeSession(sessionIndices, `随机${size}题`);
      }
      // Full practice session
      function startFullPractice() {
        const indices = questions.map((_, idx) => idx);
        startPracticeSession(indices, '完整刷题');
      }
      // Resume incomplete session from history
      function resumeSession(historyIndex) {
        const entry = sessionHistory[historyIndex];
        if (!entry) return;
        mode = 'session';
        sessionOrder = Array.isArray(entry.order) ? entry.order.slice() : [];
        if (sessionOrder.length === 0) {
          sessionOrder = questions.map((_, idx) => idx);
        }
        sessionSize = entry.size;
        sessionName = entry.mode;
        sessionCurrentIndex = entry.attempted || 0;
        sessionWrong = Array.isArray(entry.wrongQuestions) ? entry.wrongQuestions.slice() : [];
        currentHistoryResumeIndex = historyIndex;
        savedSessionState = null;
        topActionsEl.innerHTML = `<span>当前模式: ${sessionName}</span><button id="exitSessionBtn">退出并保存到历史记录</button>`;
        contentEl.classList.remove('hidden');
        showCurrentQuestion();
      }
      // Start a new practice session
      function startPracticeSession(indices, name) {
        currentHistoryResumeIndex = null;
        savedSessionState = null;
        mode = 'session';
        sessionOrder = indices;
        sessionSize = indices.length;
        sessionName = name;
        topActionsEl.innerHTML = `<span>当前模式: ${sessionName}</span><button id="exitSessionBtn">退出并保存到历史记录</button>`;
        if (updateArea) updateArea.classList.add('hidden');
        sessionCurrentIndex = 0;
        sessionWrong = [];
        contentEl.classList.remove('hidden');
        showCurrentQuestion();
      }
      // End a session and show summary
      function endSession() {
        const wrongCount = sessionWrong.length;
        const attemptedCount = sessionCurrentIndex;
        if (currentHistoryResumeIndex !== null) {
          const entry = sessionHistory[currentHistoryResumeIndex];
          entry.timestamp = Date.now();
          entry.mode = sessionName;
          entry.size = sessionSize;
          entry.attempted = attemptedCount;
          entry.wrongCount = wrongCount;
          entry.wrongQuestions = sessionWrong.slice();
          entry.order = sessionOrder.slice();
        } else {
          const entry = { timestamp: Date.now(), mode: sessionName, size: sessionSize, attempted: attemptedCount, wrongCount: wrongCount, wrongQuestions: sessionWrong.slice(), order: sessionOrder.slice() };
          sessionHistory.push(entry);
        }
        localStorage.setItem('smart_sessionHistory', JSON.stringify(sessionHistory));
        currentHistoryResumeIndex = null;
        savedSessionState = null;
        let summaryHtml = `<div class="session-summary"><h2>练习模式 “${sessionName}” 已结束</h2><p>作答情况：${attemptedCount} / ${sessionSize}</p><p>答错题数：${wrongCount}</p>`;
        if (wrongCount > 0) {
          summaryHtml += '<ul>';
          sessionWrong.forEach(item => {
            summaryHtml += `<li>题号${item.number}：正确答案 ${item.correctAnswer}（你的答案：${item.userAnswer}）</li>`;
          });
          summaryHtml += '</ul>';
        } else if (attemptedCount > 0) {
          summaryHtml += '<p>全部答对！</p>';
        }
        summaryHtml += '<button id="sessionReturnBtn">返回答题区</button> <button id="viewHistoryBtn">查看历史记录</button></div>';
        contentEl.innerHTML = summaryHtml;
        contentEl.classList.remove('hidden');
        progressEl.textContent = '';
        document.getElementById('sessionReturnBtn').addEventListener('click', () => {
          mode = 'quiz';
          restoreTopActions();
          contentEl.classList.add('hidden');
          contentEl.innerHTML = '';
          progressEl.textContent = '';
        });
        document.getElementById('viewHistoryBtn').addEventListener('click', showHistory);
      }
      // Show history page
      function showHistory() {
        mode = 'history';
        sessionHistory = JSON.parse(localStorage.getItem('smart_sessionHistory') || '[]');
        topActionsEl.innerHTML = `<span>历史记录</span>`;
        progressEl.textContent = '';
        if (updateArea) updateArea.classList.add('hidden');
        let html = '<div class="history-container">';
        if (!sessionHistory.length) {
          html += '<p>暂无刷题历史记录</p>';
        } else {
          html += `<div class="history-header"><h2>刷题历史记录</h2><button id="clearHistoryBtn" class="delete-btn">清除所有记录</button></div>`;
          sessionHistory.slice().reverse().forEach((entry, idx) => {
            const originalIndex = sessionHistory.length - 1 - idx;
            const date = new Date(entry.timestamp);
            const dateStr = date.toLocaleString('zh-CN');
            const attemptedText = entry.attempted !== undefined ? `答${entry.attempted}题` : '';
            const resultText = `错${entry.wrongCount}题`;
            html += `
              <div class="history-entry">
                <details>
                  <summary>
                    <div class="summary-info">
                      <span class="info-main">${entry.mode}</span>
                      <span class="info-sub">${dateStr} | ${attemptedText} | ${resultText}</span>
                    </div>
                    <button class="delete-btn delete-single-btn" data-index="${originalIndex}">删除</button>
                  </summary>
                  <div class="history-details">`;
            if (entry.wrongCount > 0) {
              html += '<ul>';
              entry.wrongQuestions.forEach(item => {
                html += `<li>题号${item.number}：正确答案 ${item.correctAnswer}（你的答案：${item.userAnswer}）</li>`;
              });
              html += '</ul>';
            } else if (entry.attempted > 0) {
              html += '<p>全部答对！</p>';
            } else {
              html += '<p>未作答题目。</p>';
            }
            if (entry.attempted < entry.size) {
              html += `<p><button class="resume-btn" data-index="${originalIndex}">继续练习</button></p>`;
            }
            html += '</div></details></div>';
          });
        }
        html += '<button id="historyBackBtn">返回答题区</button></div>';
        contentEl.innerHTML = html;
        contentEl.classList.remove('hidden');
        const historyContainer = contentEl.querySelector('.history-container');
        if (historyContainer) {
          historyContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('delete-single-btn')) {
              event.preventDefault();
              event.stopPropagation();
              const indexToDelete = parseInt(event.target.dataset.index, 10);
              if (confirm('您确定要删除这条记录吗？')) {
                sessionHistory.splice(indexToDelete, 1);
                localStorage.setItem('smart_sessionHistory', JSON.stringify(sessionHistory));
                showHistory();
              }
              return;
            }
            if (event.target.id === 'clearHistoryBtn') {
              if (confirm('您确定要清除所有历史记录吗？此操作无法撤销。')) {
                sessionHistory = [];
                localStorage.removeItem('smart_sessionHistory');
                showHistory();
              }
              return;
            }
            if (event.target.classList.contains('resume-btn')) {
              event.preventDefault();
              event.stopPropagation();
              const idx = parseInt(event.target.dataset.index, 10);
              resumeSession(idx);
              return;
            }
          });
        }
        document.getElementById('historyBackBtn').addEventListener('click', () => {
          mode = 'quiz';
          restoreTopActions();
          contentEl.classList.add('hidden');
          contentEl.innerHTML = '';
          progressEl.textContent = '';
        });
      }
      // Render current question according to mode
      function showCurrentQuestion() {
        let qIndex;
        if (mode === 'quiz') {
          if (order.length === 0) return;
          currentIndex = Math.max(0, Math.min(currentIndex, order.length - 1));
          qIndex = order[currentIndex];
        } else if (mode === 'wrong') {
          updateWrongOrder();
          if (wrongOrder.length === 0) {
            contentEl.innerHTML = '<p>没有错题～</p>';
            progressEl.textContent = '';
            return;
          }
          wrongIndex = Math.max(0, Math.min(wrongIndex, wrongOrder.length - 1));
          qIndex = wrongOrder[wrongIndex];
        } else if (mode === 'session') {
          if (sessionCurrentIndex >= sessionOrder.length) {
            endSession();
            return;
          }
          qIndex = sessionOrder[sessionCurrentIndex];
        } else {
          return;
        }
        const q = questions[qIndex];
        let total, currentPos;
        if (mode === 'quiz') { total = order.length; currentPos = currentIndex + 1; }
        else if (mode === 'wrong') { total = wrongOrder.length; currentPos = wrongIndex + 1; }
        else if (mode === 'session') { total = sessionOrder.length; currentPos = sessionCurrentIndex + 1; }
        const displayType = (q.options.length === 0) ? '判断' : q.type;
        progressEl.textContent = `【${displayType}】【${currentPos}/${total}】`;
        wrongCounts = JSON.parse(localStorage.getItem('smart_wrongCounts') || '{}');
        const wrongCount = wrongCounts[q.number] || 0;
        let html = `<div class="question-container"><div class="question-header">${wrongCount > 0 ? `<span class="badge">已错 ${wrongCount} 次</span>` : ''}<span>${q.question}</span></div><div class="options">`;
        let inputType;
        if (q.options.length === 0) {
          inputType = 'radio';
          [{ value: 'T', label: '正确' }, { value: 'F', label: '错误' }].forEach(opt => {
            html += `<div class="option"><label><input type="${inputType}" name="answer" value="${opt.value}"> ${opt.label}</label></div>`;
          });
        } else {
          inputType = (q.type === '多选') ? 'checkbox' : 'radio';
          q.options.forEach(opt => {
            let text = (opt.text || '').trim() || '（空）';
            html += `<div class="option"><label><input type="${inputType}" name="answer" value="${opt.label}"> ${opt.label}、${text}</label></div>`;
          });
        }
        html += `</div><div class="buttons"><button id="submitBtn">提交答案</button><button id="retryBtn" class="hidden">再试一次</button><button id="prevBtn" class="hidden">上一题</button><button id="nextBtn" class="hidden">下一题</button><button id="removeWrongBtn" class="hidden">从错题本中移除</button></div><div id="feedback" class="feedback"></div></div>`;
        contentEl.innerHTML = html;
        const submitBtn = document.getElementById('submitBtn');
        const retryBtn = document.getElementById('retryBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const removeWrongBtn = document.getElementById('removeWrongBtn');
        submitBtn.addEventListener('click', () => handleSubmit(q, inputType, submitBtn, retryBtn, nextBtn, removeWrongBtn));
        retryBtn.addEventListener('click', showCurrentQuestion);
        nextBtn.addEventListener('click', () => {
          if (mode === 'quiz') {
            currentIndex++;
            if (currentIndex >= order.length) currentIndex = 0;
          } else if (mode === 'wrong') {
            wrongIndex++;
            if (wrongIndex >= wrongOrder.length) wrongIndex = 0;
          } else if (mode === 'session') {
            sessionCurrentIndex++;
            if (currentHistoryResumeIndex !== null) {
              const resumeEntry = sessionHistory[currentHistoryResumeIndex];
              resumeEntry.attempted = sessionCurrentIndex;
              resumeEntry.wrongCount = sessionWrong.length;
              resumeEntry.wrongQuestions = sessionWrong.slice();
              resumeEntry.order = sessionOrder.slice();
              localStorage.setItem('smart_sessionHistory', JSON.stringify(sessionHistory));
            }
          }
          showCurrentQuestion();
        });
        removeWrongBtn.addEventListener('click', () => {
          delete wrongCounts[q.number];
          localStorage.setItem('smart_wrongCounts', JSON.stringify(wrongCounts));
          removeWrongBtn.textContent = '已移除';
          removeWrongBtn.disabled = true;
        });
        // Previous question
        if (prevBtn) {
          prevBtn.addEventListener('click', () => {
            if (mode === 'quiz') {
              if (currentIndex > 0) {
                currentIndex--;
              }
            } else if (mode === 'wrong') {
              if (wrongIndex > 0) {
                wrongIndex--;
              }
            } else if (mode === 'session') {
              if (sessionCurrentIndex > 0) {
                sessionCurrentIndex--;
              }
            }
            showCurrentQuestion();
          });
          let showPrev = false;
          if (mode === 'quiz') {
            showPrev = (currentIndex > 0);
          } else if (mode === 'wrong') {
            showPrev = (wrongIndex > 0);
          } else if (mode === 'session') {
            showPrev = (sessionCurrentIndex > 0);
          }
          if (showPrev) {
            prevBtn.classList.remove('hidden');
          } else {
            prevBtn.classList.add('hidden');
          }
        }
      }
      // Handle answer submission
      function handleSubmit(q, inputType, submitBtn, retryBtn, nextBtn, removeWrongBtn) {
        const selected = Array.from(contentEl.querySelectorAll('input[name="answer"]:checked'));
        if (selected.length === 0) { alert('请选择答案后再提交'); return; }
        const userAnswers = selected.map(el => el.value).sort();
        let correct = false;
        let correctDisplay;
        if (q.options.length === 0) {
          const isTrueAnswer = !q.answer.some(ans => ans.trim().includes('错') || ans.trim().includes('误'));
          const expected = isTrueAnswer ? 'T' : 'F';
          correct = (userAnswers.length === 1 && userAnswers[0] === expected);
          correctDisplay = isTrueAnswer ? '正确' : '错误';
        } else {
          const correctAnswers = q.answer.slice().sort();
          correct = (userAnswers.length === correctAnswers.length && userAnswers.every((v, i) => v === correctAnswers[i]));
          correctDisplay = q.answer.join('');
        }
        submitBtn.disabled = true;
        const feedbackEl = document.getElementById('feedback');
        if (correct) {
          feedbackEl.textContent = '回答正确！';
          feedbackEl.className = 'feedback correct';
          nextBtn.classList.remove('hidden');
          retryBtn.classList.add('hidden');
          if (mode === 'wrong') {
            removeWrongBtn.classList.remove('hidden');
          }
        } else {
          wrongCounts[q.number] = (wrongCounts[q.number] || 0) + 1;
          localStorage.setItem('smart_wrongCounts', JSON.stringify(wrongCounts));
          feedbackEl.textContent = '回答错误！正确答案：' + correctDisplay;
          feedbackEl.className = 'feedback incorrect';
          retryBtn.classList.remove('hidden');
          nextBtn.classList.remove('hidden');
          if (mode === 'session' && !sessionWrong.some(item => item.number === q.number)) {
            sessionWrong.push({ number: q.number, correctAnswer: correctDisplay, userAnswer: userAnswers.join('') });
            if (currentHistoryResumeIndex !== null) {
              const resumeEntry = sessionHistory[currentHistoryResumeIndex];
              resumeEntry.wrongCount = sessionWrong.length;
              resumeEntry.wrongQuestions = sessionWrong.slice();
              localStorage.setItem('smart_sessionHistory', JSON.stringify(sessionHistory));
            }
          }
        }
      }
      // Initialise the page by showing only the top actions, update area and signature
      restoreTopActions();
      contentEl.classList.add('hidden');
      contentEl.innerHTML = '';
      progressEl.textContent = '';
    })();
  </script>
</body>
</html>